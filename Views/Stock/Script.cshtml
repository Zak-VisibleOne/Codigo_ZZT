<script>
    var dtStockItem;
    jQuery(document).ready(function () {
        dtStockItem = $('#dtStockItem').dataTable({
            lengthMenu: [[10, 25, 50, 100, 200, -1], [10, 25, 50, 100, 200, 'All']],
            columnDefs: [
                {
                    targets: [0], name: 'code', className: 'left', sWidth: '5%', orderable: false, render: function (data) {
                        return '<span class="badge badge-pill badge-secondary edit" style="font-size: 13px;">' + data + '</span>';
                    }
                },
                {
                    targets: [1], name: 'description', className: 'left', orderable: false, sWidth: '10%',
                },
                {
                    targets: [2], name: 'saleamount', className: 'left', orderable: false, sWidth: '5%',
                },
                {
                    targets: [3], name: 'purchaseamount', className: 'left', orderable: false, sWidth: '5%',
                },
                {
                    targets: [4], name: 'category', className: 'left', orderable: false, sWidth: '5%',
                },
                {
                    targets: [5], name: 'action', className: 'left', sWidth: '5%', orderable: false,
                    editor: { type: 'action', required: false, class: '' }, render: _RenderContentButton
                },
                {
                    targets: [6], name: 'ID', visible: false,
                }
            ]
        });
        dtStockItem.on('click', '.edit', function (e) {
            e.preventDefault();
            var pos = dtStockItem.fnGetPosition($(this).closest('tr')[0]);
            var data = dtStockItem.fnGetData(pos);
            var id = data[6];
            editStock(id);
        });
        dtStockItem.on('click', '.remove', function (e) {
            e.preventDefault();
            var pos = dtStockItem.fnGetPosition($(this).closest('tr')[0]);
            var data = dtStockItem.fnGetData(pos);
            var id = data[6];
            Delete(id);
        });
        LoadStockData();
        bindDDLCategory();
    });
    function bindDDLCategory() {
        $.ajax({
            type: "GET",
            url: "/Stock/getCategory",
            data: "{}",
            success: function (data) {
                var s = '<option value="-1">Select</option>';
                for (var i = 0; i < data.length; i++) {
                    s += '<option value="' + data[i].ID + '">' + data[i].CategoryName + '</option>';
                }
                $("#ddlCategory").html(s);
            }
        });
    }
    function LoadStockData() {
        var data = GetStockData();
        dtStockItem.api().clear().rows.add(data).draw();
    }
    function GetStockData() {
        var request = $.ajax({
            type: 'GET',
            dataType: 'json',
            async: false,
            beforeSend: function () {
                return true;
            },
            url: "/Stock/GetStockList",
            data: {
            }, success: function (data) {
            }
        });
        var result = request.responseJSON;
        return (result.data != null) ? result.data : [];
    }
    function clearStock() {
        $('#txtStockCode').val('');
        $('#txtStockDescription').val('');
        $("#StockImage").attr('src', '/images/users/user-4.jpg');
        $('#txtStockImageUrl').val('');
        $('#ddlCategory').val('-1');
        $('#txtSalePrice').val('0');
        $('#txtPurchasePrice').val('0');
        tinymce.get("txtRemark").setContent('');
    }
    function AddNewStock() {
        clearStock();
        $('#method').val('add');
        $('.CB_LIST').hide();
        $('.CB_FORM').show();
    }
    function closeStock() {
        clearStock();
        LoadStockData();
        $('.CB_LIST').show();
        $('.CB_FORM').hide();
    }
    function saveStock() {
        var id = $('#hidID').val();        
        var code = $('#txtStockCode').val();
        var desc = $('#txtStockDescription').val();
        var imgurl = $('#txtStockImageUrl').val();       
        var catid = $('#ddlCategory').val();
        var saleprice = $('#txtSalePrice').val();
        var purchaseprice = $('#txtPurchasePrice').val();
        var remark = tinymce.get("txtRemark").getContent();
        var method = $('#method').val();
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: "/Stock/SaveUpdateStock",
            data: {
                ID: id,
                StockCode: code,
                StockDescription: desc,          
                ImageUrl: imgurl,
                CategoryID: catid,
                SalePrice: saleprice,
                PurchasePrice: purchaseprice,
                Remark: remark,
                Method: method
            }, success: function (data) {
                var res = data.result;
                if (res.result == "success") {
                    toastr.success(res.message, "Info");
                }
                else {
                    toastr.warning(res.message, "Error");
                }
            }
        });
    }
    function editStock(id) {
        $('#hidID').val(id);
        $('#method').val('edit');
        var data = GetStockDataByID(id);
        $("#txtStockCode").removeAttr("disabled");
        $('#txtStockCode').val(data.StockCode);
        $('#txtStockDescription').val(data.StockDescription);
        $("#StockImage").attr('src', data.ImageUrl);
        $('#txtStockImageUrl').val(data.ImageUrl);
        $('#ddlCategory').val(data.CategoryID);
        $('#txtSalePrice').val(data.SalePrice);
        $('#txtPurchasePrice').val(data.PurchasePrice);
        tinymce.get("txtRemark").setContent(data.Remark == null ? '' : data.Remark);
        $('.CB_LIST').hide();
        $('.CB_FORM').show();
    }
    function GetStockDataByID(id) {
        var request = $.ajax({
            type: 'POST',
            dataType: 'json',
            async: false,
            beforeSend: function () {
                return true;
            },
            url: '/Stock/GetStockDataByID',
            data: {
                ID: id
            }, success: function (data) {
            }, error: function (jqXHR, textStatus, errorThrown) {
                show_ajax_error(jqXHR, textStatus, errorThrown);
            }
        });
        var result = request.responseJSON;
        return (result.data != null) ? result.data : [];
    }
    function SetImageStock() {
        $("#hidSelectContentName").val('Stock');
        ShowSetImage();
    }
    function DeleteStock(id) {
        swal({
            title: 'Are you sure?',
            type: 'warning',
            showCancelButton: true,
            confirmButtonClass: 'btn btn-success',
            cancelButtonClass: 'btn btn-danger m-l-10',
            confirmButtonText: 'Yes'
        }).then(function () {
            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: '/Stock/DeleteStockByID',
                data: {
                    ID: id
                }, beforeSend: function () {
                    return true;
                }, success: function (data) {
                    var res = data.result;
                    if (res.result == "success") {
                        toastr.success(res.message, "Success");
                        LoadStockData();
                    } else {
                        toastr.warning(res.message, "Error");
                    }
                }, error: function (jqXHR, textStatus, errorThrown) {
                    show_ajax_error(jqXHR, textStatus, errorThrown);
                }
            });
        })
    }
</script>